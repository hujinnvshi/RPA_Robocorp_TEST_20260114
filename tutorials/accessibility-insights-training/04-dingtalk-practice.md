# 教程 4: 钉钉实战练习

## 📋 本教程目标

完成本教程后，你将：
- 掌握钉钉应用中常用控件的定位方法
- 能够查找和记录钉钉的关键 UI 元素
- 理解复杂应用的元素树结构
- 为编写钉钉 RPA 自动化脚本做好准备

---

## 🎯 练习准备

### 准备工作

```
□ 步骤 1: 确保钉钉已安装
  - 打开钉钉客户端
  - 确保能正常登录

□ 步骤 2: 启动 Accessibility Insights
  - 打开工具
  - 点击 "Inspect" 进入检查模式

□ 步骤 3: 准备记录工具
  - 打开记事本或 Excel
  - 用于记录元素属性信息

□ 步骤 4: 调整窗口布局
  - 将钉钉和 Accessibility Insights 并排显示
  - 便于操作和观察
```

---

## 📱 练习 1: 定位主窗口元素

### 目标: 查找钉钉主窗口的关键控件

---

### 1.1 主窗口本身

```
操作步骤:
  □ 使用 Target 模式点击钉钉窗口标题栏
  □ 查看属性面板
  □ 记录以下信息:

记录表:
  ┌─────────────────┬──────────────────────────┐
  │ 属性            │ 值                        │
  ├─────────────────┼──────────────────────────┤
  │ Name            │ _________________________ │
  │ AutomationId    │ _________________________ │
  │ ClassName       │ _________________________ │
  │ ControlType     │ _________________________ │
  │ FrameworkId     │ _________________________ │
  └─────────────────┴──────────────────────────┘

思考:
  - 钉钉使用的是什么框架? (WinForm / WPF / Win32)
  - 主窗口的 Name 是中文还是英文?
```

---

### 1.2 窗口控制按钮

```
任务: 查找最小化、最大化、关闭按钮

操作步骤:
  □ 在元素树中展开 TitleBar 节点
  □ 逐个选择按钮元素
  □ 使用高亮功能确认位置

记录表:
  ┌──────────┬─────────┬───────────────┬────────────┐
  │ 按钮类型 │ Name    │ AutomationId  │ ControlType│
  ├──────────┼─────────┼───────────────┼────────────┤
  │ 最小化   │ _______ │ _____________ │ __________ │
  │ 最大化   │ _______ │ _____________ │ __________ │
  │ 关闭     │ _______ │ _____________ │ __________ │
  └──────────┴─────────┴───────────────┴────────────┘

RPA 应用示例:
  # 点击关闭按钮
  library.click('name:"关闭" AND controltype:Button')
```

---

## 🔍 练习 2: 定位搜索功能

搜索是钉钉最常用的功能之一，我们需要精确定位搜索框和搜索按钮。

---

### 2.1 搜索框

```
目标: 找到搜索输入框

操作步骤:
  □ 观察钉钉界面，找到搜索框位置
  □ 使用 Target 模式点击搜索框
  □ 确认元素类型应该是 Edit 或 TextBox

记录表:
  ┌─────────────────┬──────────────────────────┐
  │ 属性            │ 值                        │
  ├─────────────────┼──────────────────────────┤
  │ Name            │ _________________________ │
  │ AutomationId    │ _________________________ │
  │ ClassName       │ _________________________ │
  │ ControlType     │ _________________________ │
  │ IsEnabled       │ _________________________ │
  │ IsOffscreen     │ _________________________ │
  └─────────────────┴──────────────────────────┘

提示:
  - 搜索框通常有 placeholder 文字
  - 可能 Name 属性包含 "搜索" 或 "Search"
```

---

### 2.2 搜索按钮

```
任务: 找到搜索按钮（如果有）

操作步骤:
  □ 在搜索框旁边查找按钮元素
  □ 可能是放大镜图标或"搜索"文字
  □ 使用 Target 模式点击按钮

记录表:
  ┌─────────────────┬──────────────────────────┐
  │ 属性            │ 值                        │
  ├─────────────────┼──────────────────────────┤
  │ Name            │ _________________________ │
  │ AutomationId    │ _________________________ │
  │ ControlType     │ _________________________ │
  └─────────────────┴──────────────────────────┘

注意:
  - 某些版本的钉钉可能没有独立的搜索按钮
  - 按回车键直接搜索
```

---

### 2.3 完整搜索流程 RPA 代码示例

基于你记录的信息，代码可能是这样：

```python
from RPA.Windows import Windows

library = Windows()

# 1. 启动钉钉
library.open_app('DingTalkLauncher.exe')

# 2. 等待主窗口
dingtalk = library.windows_window('钉钉')

# 3. 点击搜索框（使用你记录的属性）
search_box = dingtalk.find_element('automationid:"你记录的AutomationId"')
# 或
search_box = dingtalk.find_element('name:"你记录的Name"')
search_box.click()

# 4. 输入搜索内容
library.write_text('张三')

# 5. 按回车搜索
library.send_keys('{ENTER}')

# 6. 等待搜索结果
library.wait_for_element('name:"张三"')
```

---

## 💬 练习 3: 定位聊天列表

聊天列表显示所有联系人，是 RPA 需要操作的重要区域。

---

### 3.1 聊天列表容器

```
目标: 找到聊天列表整体容器

操作步骤:
  □ 在元素树中查找包含多个联系人的容器
  □ 通常 ControlType 是 List 或 Pane
  □ 展开该节点，查看子元素

记录表:
  ┌─────────────────┬──────────────────────────┐
  │ 属性            │ 值                        │
  ├─────────────────┼──────────────────────────┤
  │ Name            │ _________________________ │
  │ AutomationId    │ _________________________ │
  │ ControlType     │ _________________________ │
  │ 子元素数量       │ _________________________ │
  └─────────────────┴──────────────────────────┘

提示:
  - 容器通常没有 Name
  - 可能有 AutomationId 如 "chat_list"
```

---

### 3.2 单个聊天列表项

```
任务: 选择一个联系人，查看其属性

操作步骤:
  □ 在聊天列表中找一个联系人（如"张三"）
  □ 使用 Target 模式点击该联系人
  □ 查看并记录属性

记录表:
  ┌─────────────────┬──────────────────────────┐
  │ 属性            │ 值                        │
  ├─────────────────┼──────────────────────────┤
  │ Name            │ _________________________ │
  │ AutomationId    │ _________________________ │
  │ ClassName       │ _________________________ │
  │ ControlType     │ _________________________ │
  └─────────────────┴──────────────────────────┘

重要观察:
  - Name 是联系人的显示名称
  - AutomationId 可能包含动态 ID（如 item_123）
  - ControlType 通常是 ListItem

思考:
  - 如果 AutomationId 是动态的，如何稳定定位?
  答案: 使用 Name 属性
```

---

### 3.3 选择特定联系人的 RPA 代码

```python
# 方式 1: 使用 Name（推荐）
contact = dingtalk.find_element('name:"张三" AND controltype:ListItem')
contact.click()

# 方式 2: 通过列表容器查找
chat_list = dingtalk.find_element('automationid:"chat_list"')
contact = chat_list.find_element('name:"张三"')
contact.click()

# 方式 3: 使用索引（不推荐，不稳定）
# 假设张三是列表中第 3 个
contacts = dingtalk.find_elements('controltype:ListItem')
contacts[2].click()  # Python 索引从 0 开始
```

---

## ✏️ 练习 4: 定位聊天窗口元素

点击联系人后，会打开聊天窗口，我们需要定位消息输入和发送相关的元素。

---

### 4.1 消息输入框

```
目标: 找到输入消息的文本框

操作步骤:
  □ 先点击一个联系人，打开聊天窗口
  □ 使用 Target 模式点击消息输入区域
  □ 确认是 Edit 类型

记录表:
  ┌─────────────────┬──────────────────────────┐
  │ 属性            │ 值                        │
  ├─────────────────┼──────────────────────────┤
  │ Name            │ _________________________ │
  │ AutomationId    │ _________________________ │
  │ ClassName       │ _________________________ │
  │ ControlType     │ _________________________ │
  │ 是否支持多行     │ _________________________ │
  └─────────────────┴──────────────────────────┘

测试:
  - 输入一些文字
  - 在 Accessibility Insights 中按 F5 刷新
  - 查看是否有新的属性出现（如 Value 属性）
```

---

### 4.2 发送按钮

```
任务: 找到"发送"按钮

操作步骤:
  □ 在输入框旁边查找发送按钮
  □ 使用 Target 模式点击按钮
  □ 记录属性信息

记录表:
  ┌─────────────────┬──────────────────────────┐
  │ 属性            │ 值                        │
  ├─────────────────┼──────────────────────────┤
  │ Name            │ _________________________ │
  │ AutomationId    │ _________________________ │
  │ ClassName       │ _________________________ │
  │ ControlType     │ _________________________ │
  │ IsEnabled       │ _________________________ │
  └─────────────────┴──────────────────────────┘

注意:
  - 某些版本有"发送"按钮
  - 某些版本使用快捷键 Ctrl+Enter 发送
  - 观察你的钉钉是哪种
```

---

### 4.3 完整发送消息的 RPA 代码

```python
from RPA.Windows import Windows

library = Windows()
dingtalk = library.windows_window('钉钉')

# 1. 搜索联系人
search_box = dingtalk.find_element('name:"搜索"')
search_box.click()
library.write_text('李四')
library.send_keys('{ENTER}')

# 2. 等待聊天窗口打开
library.wait_for_element('name:"李四"')

# 3. 点击消息输入框
# 使用你记录的 AutomationId 或 Name
input_box = dingtalk.find_element('automationid:"你记录的输入框ID"')
input_box.click()

# 4. 输入消息内容
library.write_text('你好，这是自动发送的消息')

# 5. 发送消息
# 方式 A: 点击发送按钮
send_btn = dingtalk.find_element('name:"发送"')
send_btn.click()

# 方式 B: 使用快捷键
# library.send_keys('{ENTER}')
# 或
# library.send_keys('^+{ENTER}')  # Ctrl + Enter
```

---

## 🔧 练习 5: 其他实用控件

### 5.1 表情按钮

```
任务: 找到表情/笑脸按钮

操作步骤:
  □ 在输入框工具栏中查找表情按钮
  □ 使用 Target 模式点击
  □ 记录属性

记录:
  Name: _________________________
  AutomationId: _________________________
  ControlType: _________________________
```

---

### 5.2 文件上传按钮

```
任务: 找到上传文件/图片的按钮

操作步骤:
  □ 查找夹子/回形针图标的按钮
  □ 使用 Target 模式点击
  □ 记录属性

记录:
  Name: _________________________
  AutomationId: _________________________
  ControlType: _________________________
```

---

### 5.3 截图按钮

```
任务: 找到截图按钮（剪刀图标）

操作步骤:
  □ 查找剪刀/截图图标按钮
  □ 使用 Target 模式点击
  □ 记录属性

记录:
  Name: _________________________
  AutomationId: _________________________
  ControlType: _________________________
```

---

## 📊 综合练习: 完整流程元素记录

### 任务: 记录发送消息的完整流程所需的所有元素

创建一个文档，记录以下完整流程的每个步骤：

```
流程: 发送消息给"王五"

步骤 1: 启动钉钉
  □ 主窗口 Name: _________________________

步骤 2: 点击搜索框
  □ 搜索框 Name: _________________________
  □ 搜索框 AutomationId: _________________________

步骤 3: 输入联系人名称
  □ 输入"王五"

步骤 4: 选择联系人
  □ 联系人 Name: "王五"
  □ 联系人 ControlType: _________________________

步骤 5: 点击消息输入框
  □ 输入框 AutomationId: _________________________

步骤 6: 输入消息内容
  □ 消息内容: "测试消息"

步骤 7: 发送消息
  □ 发送按钮 Name: _________________________
  □ 或使用快捷键: _________________________
```

---

## 🎯 挑战练习

### 挑战 1: 查找群聊

```
任务: 找到并定位一个群聊

步骤:
  □ 在聊天列表中找一个群聊
  □ 使用 Target 模式点击群聊
  □ 对比群聊和个人联系人的属性差异

思考:
  - 群聊的 Name 属性有什么特点?
  - 如何区分群聊和个人联系人?
  - 群聊头像的元素类型是什么?
```

---

### 挑战 2: 查找未读消息标识

```
任务: 找到未读消息红点/数字

步骤:
  □ 找一个有未读消息的联系人
  □ 使用 Target 模式尝试点击红点
  □ 记录红点元素的属性

记录:
  ControlType: _________________________
  Name: _________________________
  是否有 AutomationId: 是 / 否

思考:
  - 如何在 RPA 中判断是否有未读消息?
  - 未读消息数量如何获取?
```

---

### 挑战 3: 查找历史消息

```
任务: 在聊天窗口中查找历史消息元素

步骤:
  □ 在聊天记录中尝试选中一条消息
  □ 使用 Target 模式点击消息
  □ 记录消息元素属性

记录:
  ControlType: _________________________
  Name: _________________________
  如何区分不同时间的消息?
```

---

## 📝 元素属性总结表

完成所有练习后，填写此总结表：

| 控件用途 | 推荐定位方式 | 替代方案 | 稳定性 |
|---------|-------------|---------|-------|
| 主窗口 | `name:"钉钉"` | `classname:"..."` | 高 |
| 搜索框 | | | |
| 联系人 | | | |
| 消息输入框 | | | |
| 发送按钮 | | | |

---

## 🎓 知识检测

1. **如果 AutomationId 是动态的，应该如何定位元素？**
   <details>
   <summary>点击查看答案</summary>
   使用 Name 属性，或组合使用 Name + ControlType
   </details>

2. **如何区分群聊和个人联系人？**
   <details>
   <summary>点击查看答案</summary>
   观察 Name 属性的模式（群聊名称通常包含群字或有特殊标识），或查看元素的其他属性如 HelpText
   </details>

3. **发送消息有哪些方式？**
   <details>
   <summary>点击查看答案</summary>
   1. 点击"发送"按钮 2. 按回车键 3. 按 Ctrl+Enter（取决于钉钉版本）
   </details>

---

## 💻 实战 RPA 代码框架

基于你的练习，这是一个完整的钉钉自动化框架：

```python
from RPA.Windows import Windows
import time

class DingTalkBot:
    def __init__(self):
        self.library = Windows()
        self.dingtalk = None

    def start(self):
        """启动钉钉"""
        self.library.open_app('DingTalkLauncher.exe')
        time.sleep(3)  # 等待启动
        self.dingtalk = self.library.windows_window('钉钉')

    def send_message(self, contact_name, message):
        """发送消息给指定联系人"""
        # 1. 搜索联系人
        search_box = self.dingtalk.find_element('你记录的搜索框定位')
        search_box.click()
        self.library.write_text(contact_name)
        self.library.send_keys('{ENTER}')

        # 2. 等待聊天窗口
        time.sleep(1)

        # 3. 输入消息
        input_box = self.dingtalk.find_element('你记录的输入框定位')
        input_box.click()
        self.library.write_text(message)

        # 4. 发送
        send_btn = self.dingtalk.find_element('你记录的发送按钮定位')
        send_btn.click()

        print(f"✅ 已发送消息给 {contact_name}")

# 使用示例
bot = DingTalkBot()
bot.start()
bot.send_message("张三", "你好，这是测试消息")
```

---

## 📝 学习笔记

```
在本教程中，我学到了:

1. 钉钉的主要元素类型:
   - 主窗口 (Window)
   - 搜索框 (Edit)
   - 联系人列表 (List / ListItem)
   - 消息输入框 (Edit)
   - 发送按钮 (Button)

2. 元素定位策略:
   - 优先使用 AutomationId（如果存在且稳定）
   - 其次使用 Name（特别是用户名称）
   - 最后组合使用多个属性

3. 复杂应用的元素树:
   - 层级可能很深
   - 需要耐心探索
   - 建议绘制元素树草图

4. 实战经验:
   - 不同版本的钉钉元素可能不同
   - 某些元素可能是动态生成的
   - 需要测试多种定位方式
```

---

## 🚀 下一步

完成了钉钉实战练习！现在让我们学习[教程 5: 常见问题与技巧](./05-tips-and-tricks.md)，掌握处理复杂情况的方法！

---

**💡 小贴士:** 建议将你的元素记录保存为 CSV 或 Excel 文件，方便后续编写代码时查询！
